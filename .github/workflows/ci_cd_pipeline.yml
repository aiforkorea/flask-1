name: Team Flask CI/CD

on:
  push:
    branches: [ main ]  # main 브랜치에 푸시될 때 실행
  pull_request:
    branches: [ main ] # main 브랜치로 PR이 들어올 때 실행

jobs:
  test_code: # CI (지속적 통합) - 코드 테스트 작업
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: pip install -r requirements.txt

    - name: Run Pytest # Pytest를 사용하여 테스트 코드 실행
      run: pytest test_app.py

  deploy_to_render: # CD (지속적 배포) - 배포 작업
    needs: test_code # test_code 작업이 성공해야만 실행
    runs-on: ubuntu-latest
    if: success() && github.ref == 'refs/heads/main' # 테스트 성공 및 main 브랜치 푸시 시에만 실행

    steps:
      - name: Trigger Render Deploy Hook
        # 4단계에서 설정할 비밀 변수 사용
        env:
          DEPLOY_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }} 
        run: |
          echo "Render 배포 시작 요청..."
          curl -X POST "$DEPLOY_URL" 